<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Dashboard</title>
  <style>
    :root{ --nav-h:62px; --gap:14px; --radius:14px; }
    html,body{ height:auto; margin:0; background:#0e0f12; color:#e9edf4;
      -webkit-font-smoothing:antialiased; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    .app{ min-height:100svh; padding-bottom:calc(var(--nav-h) + env(safe-area-inset-bottom)); }
    .content{ padding:16px; padding-top:calc(10px + env(safe-area-inset-top)); max-width:760px; margin:0 auto;
      overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; display:flex; flex-direction:column; gap:var(--gap); }
    h1.title{ font-size:36px; letter-spacing:.2px; margin:0 0 4px 0; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
    .card{ background:#14161b; border-radius:var(--radius); padding:14px 16px;
      box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 6px 20px rgba(0,0,0,.22); }
    .kpi .label{ font-size:12px; opacity:.7; }
    .kpi .value{ font-size:22px; font-weight:800; margin-top:2px; }
    .muted{ opacity:.75; font-size:12px; }
    .chart-wrap{ background:#14161b; border-radius:var(--radius); padding:10px 12px; height:210px; }
    canvas{ max-width:100%; }
    .section-title{ font-weight:800; font-size:20px; margin:0 0 8px 0; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:#101217; border:1px solid rgba(255,255,255,.06); font-size:12px; }
    .tx{ display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px dashed rgba(255,255,255,.06); }
    .tx:last-child{ border-bottom:none; }
    .tx .meta{ font-size:12px; opacity:.7; }
    .pos{ color:#87e890; } .neg{ color:#ff6f6f; }
    /* bottom nav — fixed, simple */
    .nav{ position:fixed; left:0; right:0; bottom:0; height:var(--nav-h);
      padding:8px 12px calc(8px + env(safe-area-inset-bottom)); background:rgba(15,16,20,.92);
      backdrop-filter:blur(8px); display:flex; gap:10px; justify-content:space-around; align-items:center;
      border-top:1px solid rgba(255,255,255,.06); z-index:20;}
    .nav a{ flex:1; text-align:center; color:#e9edf4; text-decoration:none; font-size:12px; opacity:.75; }
    .nav a.active{ opacity:1; font-weight:700; }
    *{ overscroll-behavior:contain; -webkit-tap-highlight-color:transparent; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="app">
    <div class="content">
      <h1 class="title" id="viewTitle">Dashboard</h1>

      <!-- KPIs -->
      <div class="grid kpi">
        <div class="card">
          <div class="label">Income</div>
          <div class="value" id="incomeVal">$0.00</div>
          <div class="label">This month</div>
        </div>
        <div class="card">
          <div class="label">Expenses</div>
          <div class="value" id="expenseVal">$0.00</div>
          <div class="label">This month</div>
        </div>
        <div class="card">
          <div class="label">Net</div>
          <div class="value" id="netVal">$0.00</div>
          <div class="label">This month</div>
        </div>
        <div class="card">
          <div class="label">Budget Used</div>
          <div class="value" id="budgetUsedPct">0%</div>
          <div class="label" id="budgetUsedDetail">of total budget</div>
        </div>
      </div>

      <!-- Charts (stacked) -->
      <div class="card">
        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>Daily Expenses (7d)</span>
          <span class="pill" id="dailyTotalPill">$0 last 7d</span>
        </div>
        <div class="chart-wrap"><canvas id="daily7d"></canvas></div>
      </div>

      <div class="card">
        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>30-Day Running Balance</span>
          <span class="pill" id="runBalancePill">Opening $0</span>
        </div>
        <div class="chart-wrap"><canvas id="run30"></canvas></div>
      </div>

      <!-- Recent transactions -->
      <div class="card">
        <div class="section-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>Recent Transactions</span>
          <span class="muted" id="txCount">0 items</span>
        </div>
        <div id="txList"></div>
      </div>
    </div>

    <!-- Bottom tabs -->
    <nav class="nav" aria-label="Bottom navigation">
      <a href="#dashboard" class="active">Dashboard</a>
      <a href="#overview">Overview</a>
      <a href="#budgets">Budgets</a>
      <a href="#transactions">Transactions</a>
      <a href="#settings">Settings</a>
    </nav>
  </div>

  <!-- Minimal glue (uses your data layer if present) -->
  <script>
    // prefer your data function if it exists
    async function loadTransactions(){
      try{
        if(typeof getTransactions === 'function'){
          const tx = await getTransactions(); if(Array.isArray(tx)) return tx;
        }
      }catch(e){}
      const saved = localStorage.getItem('transactions');
      return saved ? JSON.parse(saved) : [];
    }

    const sum = (arr, f=x=>x) => arr.reduce((a,c)=>a+f(c),0);
    const startOfDay = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const daysAgo = n => { const d=new Date(); d.setDate(d.getDate()-n); return startOfDay(d); };

    function calcSummary(tx){
      const now = new Date(), m = now.getMonth(), y = now.getFullYear();
      const inMo = tx.filter(t => { const d = new Date(t.date); return d.getMonth()===m && d.getFullYear()===y; });
      const income = sum(inMo.filter(t=>t.type==='income'), t=>+t.amount);
      const expenses = sum(inMo.filter(t=>t.type==='expense'), t=>+t.amount);
      return { income, expenses, net: +(income-expenses).toFixed(2) };
    }
    function daily7(tx){
      const b = Array.from({length:7},(_,i)=>({d:startOfDay(daysAgo(6-i)), total:0}));
      tx.forEach(t=>{
        if(t.type!=='expense') return;
        const td = startOfDay(new Date(t.date)).getTime();
        const bin = b.find(v=>v.d.getTime()===td); if(bin) bin.total += +t.amount;
      }); return b;
    }
    function run30(tx, opening=0){
      const c = daysAgo(29); let bal = opening;
      const inRange = tx.filter(t => new Date(t.date) >= c).sort((a,b)=>new Date(a.date)-new Date(b.date));
      const series=[]; for(let i=0;i<30;i++){
        const day = startOfDay(daysAgo(29-i));
        inRange.filter(t=>startOfDay(new Date(t.date)).getTime()===day.getTime())
               .forEach(t=> bal += (t.type==='income'? +t.amount : -Math.abs(+t.amount)));
        series.push({d:day, bal:+bal.toFixed(2)});
      } return series;
    }
    function fmt(n){ return '$'+Number(n).toFixed(2); }

    // chart defaults (legible)
    if(window.Chart){
      Chart.defaults.color = '#cfd6e4';
      Chart.defaults.font.family = 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
      Chart.defaults.scale.grid.color = 'rgba(255,255,255,0.06)';
      Chart.defaults.plugins.legend.labels.boxWidth = 10;
    }
    function renderBar(ctx, buckets){
      return new Chart(ctx,{type:'bar',
        data:{labels:buckets.map(b=>(b.d.getMonth()+1)+'/'+b.d.getDate()),
              datasets:[{label:'Spend', data:buckets.map(b=>+b.total.toFixed(2))}]},
        options:{responsive:true,maintainAspectRatio:false,scales:{x:{grid:{display:false}},y:{beginAtZero:true}}}
      });
    }
    function renderLine(ctx, series){
      return new Chart(ctx,{type:'line',
        data:{labels:series.map(p=>(p.d.getMonth()+1)+'/'+p.d.getDate()),
              datasets:[{label:'Balance', data:series.map(p=>p.bal), tension:.35, pointRadius:0}]},
        options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:false}}}
      });
    }

    (async function init(){
      const tx = await loadTransactions();

      // KPIs
      const {income, expenses, net} = calcSummary(tx);
      document.getElementById('incomeVal').textContent  = fmt(income);
      document.getElementById('expenseVal').textContent = fmt(expenses);
      document.getElementById('netVal').textContent     = (net<0?'-':'')+fmt(Math.abs(net));

      // Budget (simple text only; set your total in localStorage.budgetTotal)
      const total = parseFloat(localStorage.getItem('budgetTotal')||'0');
      const pct = total ? Math.min(100, (expenses/total)*100) : 0;
      document.getElementById('budgetUsedPct').textContent = Math.round(pct)+'%';
      document.getElementById('budgetUsedDetail').textContent = total ? `of $${total.toFixed(0)}` : 'No total set';

      // Charts
      const d7 = daily7(tx);
      document.getElementById('dailyTotalPill').textContent = fmt(d7.reduce((a,c)=>a+c.total,0))+' last 7d';
      renderBar(document.getElementById('daily7d'), d7);
      const s30 = run30(tx, 0);
      document.getElementById('runBalancePill').textContent = 'Opening $0';
      renderLine(document.getElementById('run30'), s30);

      // Recent tx
      const list = document.getElementById('txList');
      const fmtDate = d => new Date(d).toLocaleString([], {month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'});
      const recent = [...tx].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,6);
      document.getElementById('txCount').textContent = `${recent.length} items`;
      list.innerHTML = recent.map(t=>`
        <div class="tx">
          <div>
            <div style="font-weight:600;">${t.description||'—'}</div>
            <div class="meta">${fmtDate(t.date)} • ${t.category||''}</div>
          </div>
          <div class="${t.type==='expense'?'neg':'pos'}">${t.type==='expense'?'-':''}${fmt(t.amount)}</div>
        </div>`).join('');
    })();

    // mark active tab by hash (no heavy router)
    (function markActive(){
      const set = () => {
        const hash = (location.hash||'#dashboard');
        document.querySelectorAll('.nav a').forEach(a => a.classList.toggle('active', a.getAttribute('href')===hash));
        document.getElementById('viewTitle').textContent = (hash.slice(1).charAt(0).toUpperCase()+hash.slice(2));
      };
      window.addEventListener('hashchange', set); set();
    })();
  </script>
<script>
/* ===== PATCH R: real tabs (auto panels + router) ===== */
(function () {
  const TABS = ['dashboard','overview','budgets','transactions','settings'];
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const content = $('.content');
  if (!content) return;

  // If no panels exist yet, auto-wrap current content as Dashboard and add the rest.
  if (!$('#panel-dashboard')) {
    const dash = document.createElement('section');
    dash.id = 'panel-dashboard';
    while (content.firstChild) dash.appendChild(content.firstChild);
    content.appendChild(dash);

    // Overview (simple note — keep calm)
    const ov = document.createElement('section');
    ov.id = 'panel-overview'; ov.style.display = 'none';
    ov.innerHTML = `
      <div class="card"><div class="section-title">Overview</div>
      <div class="muted">High-level snapshot. (Same KPIs as Dashboard.)</div></div>`;
    content.appendChild(ov);

    // Budgets (inline total input)
    const bu = document.createElement('section');
    bu.id = 'panel-budgets'; bu.style.display = 'none';
    bu.innerHTML = `
      <div class="card"><div class="section-title">Budgets</div>
        <div class="muted">Set your monthly budget total.</div>
        <div style="display:flex;gap:10px;margin-top:8px;">
          <input id="budgetInput" type="number" min="0" step="1" inputmode="numeric"
                 style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0f1116;color:#e9edf4;">
          <button id="saveBudget" style="padding:10px 14px;border-radius:10px;border:0;background:#4c6fff;color:white;">Save</button>
        </div>
      </div>`;
    content.appendChild(bu);

    // Transactions (full list)
    const tr = document.createElement('section');
    tr.id = 'panel-transactions'; tr.style.display = 'none';
    tr.innerHTML = `<div class="card"><div class="section-title">All Transactions</div><div id="txAll"></div></div>`;
    content.appendChild(tr);

    // Settings (light placeholder)
    const st = document.createElement('section');
    st.id = 'panel-settings'; st.style.display = 'none';
    st.innerHTML = `<div class="card"><div class="section-title">Settings</div><div class="muted">More options coming.</div></div>`;
    content.appendChild(st);
  }

  // Minimal router
  function setActive(tab) {
    // nav highlight
    $$('.nav a').forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#'+tab));
    // title
    const title = $('#viewTitle'); if (title) title.textContent = tab.charAt(0).toUpperCase() + tab.slice(1);
    // panels
    TABS.forEach(t => {
      const p = $('#panel-'+t);
      if (p) p.style.display = (t === tab ? 'block' : 'none');
    });
    // scroll to top of content, not behind the nav
    window.scrollTo({ top: 0, behavior: 'instant' in window ? 'instant' : 'auto' });
    // populate transactions list if that panel is visible
    if (tab === 'transactions') renderTxAll();
    // preset budget input if present
    if (tab === 'budgets') {
      const inp = $('#budgetInput');
      if (inp) inp.value = String(parseFloat(localStorage.getItem('budgetTotal') || '0') || 0);
    }
  }

  // Hook bottom nav clicks
  $('.nav')?.addEventListener('click', (e) => {
    const t = e.target.closest('a[href^="#"]'); if (!t) return;
    e.preventDefault();
    const tab = t.getAttribute('href').slice(1);
    history.pushState({tab}, '', '#'+tab);
    setActive(tab);
  }, { passive: false });

  // Back/forward support
  window.addEventListener('popstate', () => setActive((location.hash || '#dashboard').slice(1)));

  // Render all transactions (simple)
  function renderTxAll() {
    const host = $('#txAll'); if (!host) return;
    const saved = localStorage.getItem('transactions');
    const tx = saved ? JSON.parse(saved) : [];
    const fmt = n => '$'+Number(n).toFixed(2);
    const fmtDate = d => new Date(d).toLocaleString([], {month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    host.innerHTML = tx.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => `
      <div class="tx">
        <div>
          <div style="font-weight:600;">${t.description || '—'}</div>
          <div class="meta">${fmtDate(t.date)} • ${t.category || ''}</div>
        </div>
        <div class="${t.type==='expense'?'neg':'pos'}">${t.type==='expense'?'-':''}${fmt(t.amount)}</div>
      </div>`).join('');
  }

  // Budget save
  document.addEventListener('click', (e) => {
    if (!e.target.closest || !e.target.closest('#saveBudget')) return;
    const v = parseFloat($('#budgetInput').value || '0');
    localStorage.setItem('budgetTotal', String(Math.max(0, v || 0)));
    alert('Budget saved');
  });

  // Boot
  const bootTab = (location.hash || '#dashboard').slice(1);
  if (!location.hash) history.replaceState({tab: 'dashboard'}, '', '#dashboard');
  setActive(bootTab);
})();
</script>
<!-- ===== PATCH-TX: Add Transaction (sheet + categories) ===== -->
<style>
  /* compact pill button */
  .btn-pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
    background:#1a1d24;color:#e9edf4;font-weight:600;font-size:14px}
  .btn-pill:active{transform:translateY(1px)}

  /* bottom sheet modal */
  #txModal{position:fixed;inset:0;display:none;z-index:50}
  #txModal.show{display:block}
  #txModal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
  #txModal .card{position:absolute;left:0;right:0;bottom:0;background:#14161b;color:#e9edf4;
    border-radius:16px 16px 0 0;padding:16px;max-height:75vh;overflow:auto;
    box-shadow:0 -10px 30px rgba(0,0,0,.4)}
  #txModal .title{font-weight:800;font-size:18px;margin-bottom:10px}
  #txModal label{font-size:12px;opacity:.8;margin-bottom:6px;display:block}
  #txModal input, #txModal select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);
    background:#0f1116;color:#e9edf4}
  #txModal .row{display:flex;gap:10px;align-items:center;margin:10px 0}
  #txModal .seg{display:flex;background:#0f1116;border:1px solid rgba(255,255,255,.1);border-radius:10px;overflow:hidden}
  #txModal .seg button{flex:1;padding:8px 10px;border:0;background:transparent;color:#cfd6e4}
  #txModal .seg button.active{background:#2a2f3a;color:#fff;font-weight:700}
  #txModal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .btn-secondary{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#1a1d24;color:#e9edf4}
  .btn-primary{padding:10px 14px;border-radius:10px;border:0;background:#4c6fff;color:#fff;font-weight:700}
</style>

<div id="txModal" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="card" role="dialog" aria-modal="true">
    <div class="title">Add Transaction</div>

    <div class="row">
      <label>Type</label>
      <div class="seg" id="txTypeSeg">
        <button type="button" data-type="expense" class="active">Expense</button>
        <button type="button" data-type="income">Income</button>
      </div>
    </div>

    <div class="row">
      <div style="flex:1">
        <label>Amount ($)</label>
        <input id="txAmount" type="number" step="0.01" inputmode="decimal" placeholder="0.00">
      </div>
      <div style="flex:1">
        <label>Date/Time</label>
        <input id="txDate" type="datetime-local">
      </div>
    </div>

    <div class="row" style="flex-direction:column">
      <label>Description</label>
      <input id="txDesc" type="text" placeholder="e.g., Groceries">
    </div>

    <div class="row">
      <div style="flex:1">
        <label>Category</label>
        <select id="txCat"></select>
      </div>
      <div style="flex:1">
        <label>Subcategory</label>
        <select id="txSub"></select>
      </div>
    </div>

    <div class="actions">
      <button class="btn-secondary" id="txCancel">Cancel</button>
      <button class="btn-primary" id="txSave">Save</button>
    </div>
  </div>
</div>

<script>
/* ===== TX ADD SHEET LOGIC ===== */
(function(){
  const $ = s=>document.querySelector(s);

  // Ensure an "+ Add" button exists on the Transactions panel header
  function ensureTxAddBtn(){
    const panel = document.getElementById('panel-transactions');
    if(!panel) return;
    const title = panel.querySelector('.section-title');
    if(!title || panel.querySelector('#txAddBtn')) return;
    const btn = document.createElement('button');
    btn.id='txAddBtn'; btn.className='btn-pill'; btn.textContent = '+ Add';
    btn.addEventListener('click', ()=>openTxModal('expense'));
    title.insertAdjacentElement('afterend', btn);
  }
  ensureTxAddBtn();
  window.addEventListener('hashchange', ()=>{ if((location.hash||'').includes('transactions')) ensureTxAddBtn(); });

  // Category tree (simple, editable)
  const CAT = {
    "Income": ["Paycheck","Bonus","Other"],
    "Rent & Housing": ["Rent","Utilities","Internet","Maintenance"],
    "Food": ["Groceries","Dining Out","Coffee","Misc"],
    "Transport": ["Gas","Rideshare","Parking","Public Transit","Tolls"],
    "Subscriptions": ["Netflix","Spotify","iCloud","Other"],
    "Personal": ["Amazon","Clothes","Health","Other"],
    "Insurance": ["Car","Medical","Renters","Other"],
    "Debt": ["Credit Card","Loan","Other"],
    "Savings": ["Emergency Fund","Investments","Other"]
  };

  // Storage helpers
  function getTx(){ try{return JSON.parse(localStorage.getItem('transactions')||'[]');}catch(e){return [];} }
  function setTx(a){ localStorage.setItem('transactions', JSON.stringify(a)); }

  // Modal wires
  const modal = $('#txModal');
  const amount = $('#txAmount'), desc = $('#txDesc'), dateIn = $('#txDate');
  const catSel = $('#txCat'), subSel = $('#txSub'), seg = $('#txTypeSeg');

  function populate(type){
    const cats = Object.keys(CAT).filter(c => type==='income' ? c==='Income' : c!=='Income');
    catSel.innerHTML = cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    const lastCat = localStorage.getItem('lastCat');
    if(lastCat && cats.includes(lastCat)) catSel.value = lastCat;
    populateSub();
  }
  function populateSub(){
    const subs = CAT[catSel.value] || ['Other'];
    subSel.innerHTML = subs.map(s=>`<option value="${s}">${s}</option>`).join('');
    const lastSub = localStorage.getItem('lastSub');
    if(lastSub && subs.includes(lastSub)) subSel.value = lastSub;
  }
  catSel.addEventListener('change', populateSub);

  seg.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-type]'); if(!b) return;
    seg.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    populate(b.dataset.type);
  });

  function openTxModal(defaultType='expense'){
    seg.querySelectorAll('button').forEach(x=>x.classList.toggle('active', x.dataset.type===defaultType));
    populate(defaultType);
    amount.value = ''; desc.value=''; 
    // default now in local timezone for iOS
    const now = new Date(); now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
    dateIn.value = now.toISOString().slice(0,16);
    modal.classList.add('show');
  }
  window.openTxModal = openTxModal; // optional external use

  function closeTxModal(){ modal.classList.remove('show'); }
  $('#txCancel').addEventListener('click', closeTxModal);
  modal.querySelector('.backdrop').addEventListener('click', closeTxModal);

  // Save
  $('#txSave').addEventListener('click', ()=>{
    const type = seg.querySelector('.active')?.dataset.type || 'expense';
    const amt = Math.abs(parseFloat(amount.value||'0'));
    if(!amt){ alert('Enter an amount'); return; }
    const when = new Date(dateIn.value || new Date());
    const tx = {
      id: 'tx_'+Date.now(),
      type,
      amount: +amt.toFixed(2),
      description: desc.value?.trim() || (type==='income'?'Quick income':'Quick expense'),
      category: catSel.value,
      subcategory: subSel.value,
      date: when.toISOString()
    };
    localStorage.setItem('lastCat', tx.category);
    localStorage.setItem('lastSub', tx.subcategory);

    const arr = getTx(); arr.push(tx); setTx(arr);
    closeTxModal();

    // Re-render if app exposes a redraw; otherwise simple reload keeps hash (stays on tab)
    if (typeof window.recalcAndRender === 'function') { window.recalcAndRender(); }
    else if (typeof window.renderTxAll === 'function') { window.renderTxAll && window.renderTxAll(); }
    else { location.reload(); }
  });

  // Allow Enter to save from amount/desc
  [amount, desc].forEach(el => el.addEventListener('keydown', e=>{ if(e.key==='Enter') $('#txSave').click(); }));
})();
</script>
</body>
</html>
